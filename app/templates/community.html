{% extends "title.html" %}
{% block content %}

<style>
    /* Container settings */
    .chat-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh; /* Use full height of the viewport */
        padding: 20px; /* Padding around the chat area */
        box-sizing: border-box;
    }

    /* Chat box design */
    .chat-box {
        width: 60%; /* Adjusted width for better display */
        max-width: 800px; /* Maximum width of the chat box */
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px; /* Rounded corners for the chat box */
        box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* Subtle shadow for depth */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .chat-messages {
        overflow-y: auto;
        padding: 10px;
        height: 300px; /* Fixed height with scrolling */
    }

    .message-input {
        border-top: 1px solid #ddd;
        padding: 10px;
        display: flex;
        align-items: center;
    }

    #message {
        flex-grow: 1;
        margin-right: 10px; /* Space between input box and button */
        padding: 10px 15px; /* Larger padding for easier typing */
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    #send {
        padding: 10px 20px;
        background-color: #0A94DB;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 4px;
    }

    /* Improvements for mobile responsiveness */
    @media (max-width: 768px) {
        .chat-box {
            width: 90%; /* Full width on smaller screens */
        }
    }
</style>


<div class="chat-container">

    <div class="chat-box">
    <button id="attend-game-btn" class="btn btn-success" onclick="attendGame({{ game.game_id }})">Attend the Game</button>
    <h2 align="center">Game Chatting Room: {{game.game_name}}</h2>
{#        <div class="user-count">#}
{#            Users in room: <span id="user-count">0</span>#}
{#        </div>#}

        <div class="chat-messages" id="chat-messages">
            {% for msg in messages %}
            <div>
                <strong>{{ msg.username }}</strong>: {{ msg.message }}
                <span class="timestamp">{{ msg.timestamp }}</span>
            </div>
            {% endfor %}
        </div>

        <div class="message-input">
            <input type="text" id="message" class="form-control" placeholder="Type a message...">
            <button onclick="sendMessage()" id="send" class="btn btn-primary">Send</button>
        </div>
    </div>
</div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
      integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
      crossorigin="anonymous"
    ></script>

<script type="text/javascript">
    var socket = io();
    var gameName = "{{ game.game_name }}";
    var userName = "{{ session['name'] }}";

    var messageQueue = [];
    var lastEmitTime = Date.now();
    var emitInterval = 5000; // Set the interval to 5000ms or 5 seconds

    socket.on('connect', function() {
        console.log('Connected to server.');
        if (gameName && userName) {
            socket.emit('join', { room: gameName, name: userName });
            console.log('Joined room:', gameName);
        } else {
            console.error('Game name or user name is not defined.');
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        var messageInput = document.getElementById("message");
        messageInput.addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });
    });

    socket.on('message', function(data) {
        messageQueue.push(data);
        if (messageQueue.length === 1) {
            setTimeout(processMessageQueue, 100); // Process messages every 100ms
        }
    });

    function processMessageQueue() {
        var chatMessages = document.getElementById("chat-messages");
        messageQueue.forEach(function(data) {
            var msgElement = document.createElement("div");
            msgElement.innerHTML = "<strong>" + data.username + "</strong>: " + data.message;
            chatMessages.appendChild(msgElement);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
        messageQueue = [];
    }

    function sendMessage() {
        var currentTime = Date.now();
        if (currentTime - lastEmitTime < emitInterval) {
            console.log('Please wait before sending another message.');
            return; // Throttle messages
        }
        var messageInput = document.getElementById("message");
        var message = messageInput.value.trim();
        if (message === "") {
            console.log('Cannot send an empty message.');
            return;
        }
        socket.emit('message', { name: userName, message: message, room: gameName });
        messageInput.value = '';
        lastEmitTime = currentTime;
        console.log('Sent message:', message);
    }

    function attendGame(gameId) {
        fetch(`/attend-game/${gameId}`, { method: 'POST' })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('attend-game-btn').innerText = 'Game Attended';
            }
            alert(data.message);
        })
        .catch(error => console.error('Error:', error));
    }
</script>


{% endblock %}
